# Меню

Вход в меню настроек осуществляется длинным нажатием на `среднюю кнопку` из `главных экранов`.

Выход обратно в главные экраны:

* Вручную - через пункт меню `Выход/Exit`.
* Автоматически - через 15 секунд, если не нажимать никаких кнопок.

Перемещение по пунктам меню - с помощью кнопок `Вверх` и `Вниз`

Некоторые пункты, где указано значение параметра справа, можно редактировать: нажимаем однократно `среднюю кнопку`, кнопками `вверх` и `вниз` меняем `значение` и завершаем редактирование повторным нажатием на `среднюю кнопку`.

Меню имеет древовидную структуру. В более глубокий уровень заходим через однократное нажатие средней кнопки. Уровнем выше поднимаемся через пункт меню "Выход"/"Exit" - он всегда в самом верху списка.


## GPS-точки

Здесь настраивается до трёх точек с координатами. Направление и расстояние до любой выбранной из них можно будет видеть на главном экране.


### Выбранная точка

Выбрать можно только одну точку. Каждая точка обозначена номером (`1`, `2`, `3`).

Если рядом с номером точки присутствует `(нет)`, значит для этой точки ещё не сохранены координаты (свободная для использования ячейка).

Вариант `[без точки]` отключает отображение стрелки и расстояния до точки на главном экране.


### Сохранить координаты

Для выбранной точки можно сохранить координаты текущего местоположения. Для этого надо удерживать 4 секунды среднюю кнопку на одноимённом пункте меню в том географическом положении, которое мы хотим сохранить.

Возможные ошибки:

* Точка не выбрана - в качестве выбранной точки: "[без точки]".
* Нет GPS спутников - потеряна связь до спутников (об этом подробнее - ниже).
* Ошибка сохранения - проблемы с внутренней flash-памятью.

Несмотря на то, что GPS-антенна находится с противоположной стороны от кнопок управления, тем не менее, на практике замечено, что при длительном нахождении пальцев в области кнопок связь до спутников может потеряться. Это актуально и для исполнения [v.0.3](https://github.com/cliffanet/xdeya-altimeter/blob/master/doc/models/01.v.0.3.md), и для исполнения [v.0.4](https://github.com/cliffanet/xdeya-altimeter/blob/master/doc/models/02.v.0.4.md).

Если потеря связи произошла, пока мы лазили по меню и пытались сохранить точку - увидев сообщение `Нет GPS спутников`, обычно достаточно на 5-8 секунд убрать пальцы от высотника и попробовать ещё раз сохранить координаты.


### Очистить точку

У выбранной точки очищаются координаты, и она становится свободным слотом.

Для сохранения координат для выбранной точки необязательно её перед этим очищать. Однако, это добавит `(нет)` к номеру точки в пункте [Сохранить координаты](#сохранить-координаты), и в будущем будет легче выбрать точку, чтобы не затереть какие-то важные координаты.


## Количество прыжков

Стандартный пункт для любого высотомера. Необходим для удобства ведения записи прыжков.

Количество прыжков автоматически увеличивается через 5 секунд после отделения от ЛА (Летательного Аппарата).


## LogBook (ЛогБук)

Сначала мы попадаем в список прыжков. Более поздний прыжок находится выше. Для каждого прыжка отображается `Время/Дата` и `Номер прыжка`.

Нажав на прыжок, увидим более подробную информацию о нём. И можно перемещаться к более ранним и более поздним прыжкам кнопками `вверх` и `вниз`.

Отображаемая информация:

* Номер прыжка (в самом вверху в заголовке)
* Дата/время (момент отделения от ЛА)
* Высота отделения (м)
* Высота раскрытия парашюта (скорость падения снижается до 10 м/с)
* Длительность взлёта (мин:сек)
* Длительность свободного падения (сек)
* Длительность парашютирования (сек)

Для каждого прыжка сохраняются четыре точки:

* Взлёт (отрыв от земли)
* Отделение от ЛА
* Раскрытие парашюта
* Приземление

Для каждой точки сохраняется:

* Дата/время
* Высота по барометру
* Все навигационные параметры

Выход из `подробной информации` обратно в `список` производится `средней кнопкой`.


## Параметры

В этом разделе можно произвести настройку устройства под свои нужды.


### Дисплей

* Подсветка - ручное включение подсветки дисплея.
* Контраст - корректировка чёткости отображения.
* Развернуть на 180 - для ношения на правой руке антенной со стороны кисти.


### Подстройка уровня земли

* Сбросить `уровень земли` вручную - примет текущее давление за `уровень земли`.
* Разрешение ручного сброса.
* Автоподстройка - вкл/выкл автоматической подстройки `уровня земли`.
* Превышение площадки приземления относительно уровня взлёта.


### Автопереключение главного экрана

Главный экран можно автоматически переключать на определённую страницу при некоторых событиях:

* Свободное падение - тут выбор только `да` или `нет`, при выборе `да` экран переключается в режим высотомера и отключает кнопки управления, пока скорость эквивалентна скорости свободного падения.
* После раскрытия
* При приземлении
* При длительном нахождении на земле
* При включении устройства

У всех пунктов, кроме первого, актуальны варианты:

* Страница `GPS + Высотомер`.
* Страница `Высотомер`.
* Предыдущая страница - та, что была выбрана до момента отделения от ЛА.
* Не менять - ничего не менять при данном событии.


### Автовыключение

Устройство можно автоматически выключить при следующих событиях:

* Выключить вручную - `длинное нажатие` на `среднюю кнопку`.
* Без взлётов - если с предыдущего взлёта (с момента приземления или включения устройства) прошло выбранное количество часов.
* После включения устройства прошло выбранное количество часов.


### Управление режимом питания GPS-приёмника

Энергопотребление GPS-приёмника весьма существенное. При его постоянно включенном состоянии полного заряда аккумулятора может не хватить даже на один световой день.

* Текущее состояние - `включение` и `выключение` питания приёмника вручную.
* Включение питания при включении устройства - `да` / `нет`.
* Включение питания при записи трека - `да` / `нет` (будет автоматически выключено при остановке записи трека).
* Включение питания на высоте - можно выбрать высоту, на которой приёмник включится автоматически (и автоматически выключится при приземлении).
* Выключать при приземлении - `да` / `нет` - независимо от настроек выше, после приземления в любом случае будет выключено.

После включения питания во всех случаях GPS-приёмник будет проинициализирован, настроен. Однако, на приём сигналов от спутников требуется некоторое время, особенно, если приёмник был с отключенным питанием длительное время.


### Функции кнопок на главных экранах

На главных экранах функциями кнопок `Вверх` и `Вниз` по `длинному нажатию` на них можно управлять:

* не исп. - отключить кнопку на главных экранах.
* Подсветка -  `вкл` / `выкл`.
* Питание GPS-приёмника -  `вкл` / `выкл`.
* Запись трека - `вкл` / `выкл`.
* Выключить питание устройства.


### Работа с треками

* Писать сейчас - отображает текущий режим записи трека. `Длинным нажатием` можно `включить` или `выключить` запись.
* Автозапись на высоте - можно выбрать высоту в подъёме, при которой запись трека включится автоматически.
* Текущее количество треков.
* Доступно для записи треков - в минутах и секундах.

При записи трека, если свободного места остаётся мало, автоматически удаляются более старые треки. Если остаётся только тот трек, который записывается в настоящее время, все остальные треки были уже удалены, а место всё равно заканчивается, запись трека будет остановлена.

**Важно:** В момент отделения от ЛА запись трека всегда начинается автоматически.

Если запись трека была изначально выключена и включилась автоматически в момент отделения от ЛА, в этом случае она автоматически выключится после приземления.


### Настройка часов

Тут выбирается часовой пояс по `UTC` с интервалом в 30 минут.

При доступности GPS-спутников часы всегда синхронизируются по ним.


## Система

В этом разделе расположены служебные функции по обслуживанию устройства.


### Выключить вручную

`Длинным нажатием` на `среднюю кнопку` выключает питание устройства.

На деле же, устройство не отключается от источника питания (аккумулятора). Центральный процессор переходит в `режим глубокого сна`, дисплей переходит в режим энергосбережения, микроконтроллер GPS отключается от питания полностью, а барометр остаётся подключенным к источнику питания - его энергопотребление минимально.

Работа центрального процессора ограничивается слежением за нажатием на кнопки, чтобы включить устройство обратно.

Обратно устройство включается `Длинным нажатием` на `среднюю кнопку`.


### Перезагрузить

`Длинным нажатием` на `среднюю кнопку` перезагружает устройство.

Функция нужна только при нештатной работе устройства.


### Сброс всех настроек

`Длинным нажатием` на `среднюю кнопку` сбрасывает все настройки устройства, в т.ч. отвязывает от Web-аккаунта.


### Обновление прошивки

Сам процесс обновления прошивки будет происходить во время синхронизации. В этом разделе можно выбрать версию прошивки, на которую обновляться.

Пункты меню:

* Текущая версия прошивки.
* Тип текущей прошивки.
* Аппаратная версия.
* Выбор прошивки, на которую обновляться.

Типы прошивки:

* prod - обычная пользовательская прошивка
* debug - как и обычная, но включен режим отладки, в консоль отправляется служебная информация
* dev - прошивка разработчика, при синхронизации используется другой сервер, специально для отладки при разработке

Для каждой версии прошивки можно выбрать язык сообщений на дисплее: `русский` и `английский`.

Обновление прошивки при синхронизации будет происходить только если выбрана версия прошивки в пункте `Выбор прошивки`.


### Файлы

Все настройки устройства, логбук и записанные треки хранятся в виде файлов на внутренней `flash-памяти`.

В данном разделе можно посмотреть, какие файлы есть во внутренней памяти, и управлять ими:

* удаление файла - `длинным нажатием` на `среднюю кнопку`
* перенумерование логбук-файлов
* перенумерование треков

Треки и логбук хранятся в файлах, которые нумеруются по порядку. Если какой-то из этих файлов будет удалён, необходимо перенумеровать весь список. Иначе логбук или треки будут некорректно работать.


### GPS serial

Включение режима GPS-serial позволяет управлять микропроцессором GPS-приёмника через серийный порт устройства.


### GPS спутники

Список всех спутников, сигнал от которых видит GPS-приёмник.

    [02 GPS ] q-1   (17/60)
    [1d GPS ] q-7   (74/95)    30 dB
    [ff GLON] q-7   (74/95)    20 db

* В квадратных скобках указан идентификатор спутника - числовой svId и тип.

* `q-N` - качество сигнала, где N:

    * 0 - нет сигнала
    * 1 - поиск сигнала
    * 2 - сигнал получен
    * 3 - сигнал определён, но его нельзя использовать
    * 4 - код заблокирован, часы синхронизированы
    * 5-7 - код и сигнал заблокированы, часы синхронизированы

* Если после `q-N` отображается `*`, значит этот спутник используется для навигации

* В круглых скобках: возвышение (-90..+90) и азимут (0..360)

* Справа - отношение сигнал/шум


### Тестирование аппаратуры

Этот раздел позволяет проверить протестировать корректность работы узлов устройства.

* Часы - Даже если не синхронизированы, время должно идти, а не стоять на месте.
* Напряжение на батарее - Показывет текущее рассчитанное напряжение, должно быть в пределах `3.0-4.2 Вольт`.
* Заряжается ли батарея - При подключении USB-зарядки должно отображать `Да`.
* Показания барометра - Текущее атмосферное давление, должно быть в пределах `9-11 кПа`.
* Подсветка экрана - Включает подсветку по длинному нажатию на `среднюю кнопку` и через секунду подсветка отключается.
* Данные с GPS-приёмника - Показывает задержку в приёме данных, она не должна превышать `500 мс`.
* Перезапуск по питанию микропроцессора GPS-приёмника -  По `длинному нажатию` на `среднюю кнопку`.
* Повторная инициализация GPS-приёмника - требуется, если GPS-приёмник был перезапущен пунктом выше.


## WiFi-синхронизация

Подробнее о процессе синхронизации рассказано в разделе [Синхронизация](08.syncronization.md#Синхронизация)
